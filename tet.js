function checkKey(e){e=e||window.event,"38"==e.keyCode?piece.rotate():"40"==e.keyCode?(piece&&piece.fall(),currentDelay=fallingDelay):"37"==e.keyCode?piece.move("left"):"39"==e.keyCode&&piece.move("right")}function checkKeyUp(e){e=e||window.event,"40"==e.keyCode&&(currentDelay=normalDelay)}function Piece(e,o,t){this.color=t,this.row=e,this.column=o,this.rotation=0,this.rotationsCount=4,1===t?this.rotationsCount=1:t>1&&5>t&&(this.rotationsCount=2);var r=this.draw();r||(this.erase(),SCOPE.$apply(function(){SCOPE.gameOver()}))}function rotationArray(e,o){var t={1:{0:[0,-1,0,0,1,-1,1,0]},2:{0:[0,-2,0,-1,0,0,0,1],1:[-1,0,0,0,1,0,2,0]},3:{0:[0,0,0,1,1,-1,1,0],1:[-1,0,0,0,0,1,1,1]},4:{0:[0,-1,0,0,1,0,1,1],1:[-1,1,0,0,0,1,1,0]},5:{0:[0,-1,0,0,0,1,1,-1],1:[-1,0,0,0,1,0,1,1],2:[-1,1,0,-1,0,0,0,1],3:[-1,-1,-1,0,0,0,1,0]},6:{0:[0,-1,0,0,0,1,1,1],1:[-1,0,-1,1,0,0,1,0],2:[-1,-1,0,-1,0,0,0,1],3:[-1,0,0,0,1,-1,1,0]},7:{0:[0,-1,0,0,0,1,1,0],1:[-1,0,0,0,0,1,1,0],2:[-1,0,0,-1,0,0,0,1],3:[-1,0,0,-1,0,0,1,0]}};return t[e][o]}function setTile(e,o,t){gameBoard[e][o].color=t}function getTile(e,o){return e>GAME_BOARD_ROWS-1||o>GAME_BOARD_COLUMNS-1||0>o?new Tile(0,0,99):gameBoard[e][o]}function removeTile(e,o){gameBoard[e][o].color=0}function removeFullRowsFromBoard(){for(var e=0,o=0;GAME_BOARD_ROWS>o;o++)isRowFull(o)&&(removeRow(o),e++);updateScore(e),checkLevel(e)}function checkLevel(e){linesCleared+=e;for(var o=1;100>o;o++)linesCleared>=5*level+5&&(level++,normalDelay=.85*normalDelay,150>normalDelay&&(normalDelay=150),currentDelay=normalDelay)}function updateScore(e){switch(e){case 1:score+=40*(level+1);break;case 2:score+=100*(level+1);break;case 3:score+=300*(level+1);break;case 4:score+=1200*(level+1)}}function removeRow(e){for(var o=e;o>0;o--)for(var t=0;GAME_BOARD_COLUMNS>t;t++){var r=getTile(o-1,t).color;setTile(o,t,r)}}function isRowFull(e){for(var o=0;GAME_BOARD_COLUMNS>o;o++)if(0==getTile(e,o).color)return!1;return!0}function getNewPiece(){return Math.floor(7*Math.random()+1)}function getRandomColumn(){return Math.floor(10*Math.random())}function generateNextPieceData(e){switch(nextPieceTable=[],e){case 1:nextPieceTable.push([new Tile(0,0,1),new Tile(0,0,1)]),nextPieceTable.push([new Tile(0,0,1),new Tile(0,0,1)]);break;case 2:nextPieceTable.push([new Tile(0,0,2),new Tile(0,0,2),new Tile(0,0,2),new Tile(0,0,2)]);break;case 3:nextPieceTable.push([new Tile(0,0,0),new Tile(0,0,3),new Tile(0,0,3)]),nextPieceTable.push([new Tile(0,0,3),new Tile(0,0,3),new Tile(0,0,0)]);break;case 4:nextPieceTable.push([new Tile(0,0,4),new Tile(0,0,4),new Tile(0,0,0)]),nextPieceTable.push([new Tile(0,0,0),new Tile(0,0,4),new Tile(0,0,4)]);break;case 5:nextPieceTable.push([new Tile(0,0,5),new Tile(0,0,5),new Tile(0,0,5)]),nextPieceTable.push([new Tile(0,0,5),new Tile(0,0,0),new Tile(0,0,0)]);break;case 6:nextPieceTable.push([new Tile(0,0,6),new Tile(0,0,6),new Tile(0,0,6)]),nextPieceTable.push([new Tile(0,0,0),new Tile(0,0,0),new Tile(0,0,6)]);break;case 7:nextPieceTable.push([new Tile(0,0,7),new Tile(0,0,7),new Tile(0,0,7)]),nextPieceTable.push([new Tile(0,0,0),new Tile(0,0,7),new Tile(0,0,0)])}SCOPE.$apply(function(){SCOPE.updateData()})}function Tile(e,o,t){this.color=t,this.row=e,this.column=o}function clearBoard(){gameBoard=[];for(var e=0;GAME_BOARD_ROWS>e;e++){for(var o=[],t=0;GAME_BOARD_COLUMNS>t;t++)o.push(new Tile(e,t,0));gameBoard.push(o)}}function scoreIsHighScore(e){return e>highScores[9].score?!0:!1}function saveHighScore(e,o){for(var t=0;10>t;t++){if(highScores[t].score<o){console.log("Score is number "+t);for(var r=9;r>t;r--)highScores[r]=highScores[r-1];highScores[t]={name:e,score:score},localStorage.setItem("tetris_highscores",JSON.stringify(highScores));break}console.log("No high score")}}var tetrisApp=angular.module("Tetris",[]),GAME_BOARD_ROWS=22,GAME_BOARD_COLUMNS=10,START_ROW=0,START_COLUMN=4,SCOPE,GAME_DELAY=1100,normalDelay=GAME_DELAY,fallingDelay=100,currentDelay=normalDelay,gameBoard=[],nextPieceTable=[],piece,pieceOnBoard=!1,linesCleared=0,score=0,level=0;clearBoard(),document.onkeydown=checkKey,document.onkeyup=checkKeyUp;var highScores=[];if(localStorage.getItem("tetris_highscores")){hs=JSON.parse(localStorage.tetris_highscores);for(var i=0;10>i;i++)highScores.push({name:hs[i].name,score:hs[i].score})}else{for(var i=10-highScores.length;i>0;i--)highScores.push({name:"UNKNOWN",score:100*i});localStorage.setItem("tetris_highscores",JSON.stringify(highScores))}tetrisApp.controller("GameController",function(e,o){e.gameStarted=!1,e.gameStartPopup=!0,e.gameOverPopup=!1,e.nameInputPopup=!1,e.loopCount=0,e.score=0,e.highScores=highScores,e.gameBoard=gameBoard,SCOPE=angular.element(document.getElementById("tetrisBody")).scope();var t,r=[];e.init=function(){console.log("init()"),e.fillNextPieces(),e.updateData()},e.gameLoop=function(){e.loopCount++,pieceOnBoard||(piece=new Piece(START_ROW,START_COLUMN,r.shift()),e.fillNextPieces(),generateNextPieceData(r[0]),pieceOnBoard=!0);var i=piece.fall();i||(pieceOnBoard=!1,piece=null,removeFullRowsFromBoard()),e.updateData(),t=pieceOnBoard?currentDelay:50,o(function(){e.restartGameLoop()},t)},e.restartGameLoop=function(){e.gameStarted&&e.gameLoop()},e.startGame=function(){console.log("startGame()"),score=0,level=0,normalDelay=GAME_DELAY,currentDelay=normalDelay,linesCleared=0,clearBoard(),e.gameStarted=!0,e.gameStartPopup=!1,e.loopCount=0,r=[],e.fillNextPieces(),e.updateData(),o(function(){e.restartGameLoop()},GAME_DELAY)},e.fillNextPieces=function(){for(;r.length<5;)r.push(getNewPiece())},e.updateData=function(){e.gameBoard=gameBoard,e.score=score,e.nextPieceTable=nextPieceTable,e.level=level,e.linesCleared=linesCleared,e.currentDelay=currentDelay},e.gameOver=function(){e.gameOverPopup=!0,e.gameStarted=!1,o(function(){e.clearGameOverPopup()},4e3)},e.clearGameOverPopup=function(){e.gameOverPopup=!1,r=[],nextPieceTable=[],e.updateData(),e.checkIfHighScore()},e.checkIfHighScore=function(){scoreIsHighScore(score)?e.nameInputPopup=!0:(e.gameStartPopup=!0,console.log("Did not make to high score list."))},e.saveScore=function(){e.nameInputPopup=!1,saveHighScore(e.userName.toUpperCase(),score),e.gameStartPopup=!0},e.init()}),tetrisApp.filter("slice",function(){return function(e,o,t){return(e||[]).slice(o,t)}}),Piece.prototype.toString=function(){return"("+this.row+", "+this.column+": "+this.color+", r"+this.rotation+")"},Piece.prototype.fall=function(){this.erase(),this.row++;var e=this.draw();return e||(this.row--,this.draw()),score++,e},Piece.prototype.move=function(e){this.erase(),"left"===e&&this.column--,"right"===e&&this.column++;var o=this.draw();o||("left"===e&&this.column++,"right"===e&&this.column--,this.draw())},Piece.prototype.rotate=function(){this.erase(),this.rotation++;var e=this.draw();e||(this.rotation--,this.draw())},Piece.prototype.erase=function(){this.draw("remove")},Piece.prototype.draw=function(e){var o=this.color;if("remove"===e)o=0;else for(r=rotationArray(this.color,this.rotation%this.rotationsCount);r.length>0;){var t=getTile(this.row+r.shift(),this.column+r.shift()).color;if(t>0)return!1}for(r=rotationArray(this.color,this.rotation%this.rotationsCount);r.length>0;)setTile(this.row+r.shift(),this.column+r.shift(),o);return SCOPE.$apply(function(){SCOPE.updateData()}),!0},Tile.prototype.toString=function(){return"("+this.row+", "+this.column+": "+this.color+")"};